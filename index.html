<!doctype html>    
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Pantalla con QR ‚Äî Edici√≥n + Subida remota (sin Storage)</title>

<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;700;900&family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">

<style>
:root{ --bg:#000; --text:#fff; --title-font:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
*{box-sizing:border-box}
body{margin:0;background:#0b0e14;color:#fff;font-family:"Poppins",system-ui}
.hidden{display:none}

/* Header / layout */
header{position:sticky;top:0;z-index:5;background:rgba(0,0,0,.5);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.08)}
.wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
.badge{font-size:12px;padding:4px 8px;border:1px solid rgba(255,255,255,.18);border-radius:999px;color:#cbd5e1}
.tabs{display:flex;gap:8px}
.tab{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#e2e8f0;cursor:pointer}
.tab.active{background:rgba(255,255,255,.14)}
main{max-width:1100px;margin:0 auto;padding:18px 16px 56px}
.card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px}

/* Viewer */
.viewer{width:100%;aspect-ratio:16/9;background:var(--bg);border:1px solid rgba(255,255,255,.12);border-radius:16px;position:relative;overflow:hidden}
.viewer:fullscreen{width:100vw;height:100vh;aspect-ratio:auto;border-radius:0;border:none}
.cvfx{position:absolute;inset:0;z-index:1;pointer-events:none}

/* ===== CAPA DE DISE√ëOS ===== */
.fx-design{
  position:absolute;
  inset:-15%;
  z-index:2;
  pointer-events:none;
  background-repeat:no-repeat;
  background-position:center;
  background-size:cover;
  filter:drop-shadow(0 0 20px rgba(0,0,0,.4));
  content:"";
}
.fx-design::before,
.fx-design::after{
  content:"";
  position:absolute;
  inset:-10%;
  pointer-events:none;
}

/* Estrellas */
.d-stars{
  background:
    radial-gradient(circle at 50% 40%, rgba(11,14,20,0) 0, rgba(11,14,20,1) 65%),
    radial-gradient(circle at 10% 10%, rgba(255,255,255,.05) 0, rgba(255,255,255,0) 40%);
  mix-blend-mode:screen;
}
.d-stars::before{
  background-image:
    radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,.95) 0, rgba(255,255,255,0) 40%),
    radial-gradient(1.6px 1.6px at 30% 80%, rgba(255,255,255,.9) 0, rgba(255,255,255,0) 45%),
    radial-gradient(1.2px 1.2px at 70% 30%, rgba(255,255,255,.85) 0, rgba(255,255,255,0) 42%),
    radial-gradient(2.8px 2.8px at 90% 70%, rgba(255,215,0,.9) 0, rgba(255,215,0,0) 50%),
    radial-gradient(1.4px 1.4px at 50% 50%, rgba(156,163,255,.9) 0, rgba(156,163,255,0) 45%);
  background-size:160px 160px,180px 180px,200px 200px,240px 240px,220px 220px;
  animation: skyMove 35s linear infinite;
  opacity:.95;
}
.d-stars::after{
  background:
    radial-gradient(circle at 20% 60%, rgba(255,255,255,.12) 0, rgba(255,255,255,0) 45%),
    radial-gradient(circle at 80% 25%, rgba(255,225,150,.2) 0, rgba(255,225,150,0) 48%),
    radial-gradient(circle at 50% 88%, rgba(130,170,255,.18) 0, rgba(130,170,255,0) 50%);
  mix-blend-mode:screen;
  animation: twinkle 6s ease-in-out infinite alternate;
  opacity:.8;
}
@keyframes skyMove{
  0%{transform:translateX(0) translateY(0)}
  100%{transform:translateX(6%) translateY(8%)}
}
@keyframes twinkle{
  from{opacity:.35}
  to{opacity:1}
}

/* Luces */
.d-lights{
  background:
    radial-gradient(circle at 12% -12%, rgba(255,255,255,1) 0, rgba(255,255,255,0) 55%),
    radial-gradient(circle at 88% -14%, rgba(255,214,165,1) 0, rgba(255,214,165,0) 55%),
    linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.5) 70%);
  mix-blend-mode:screen;
}
.d-lights::before{
  background-image:
    linear-gradient(120deg, rgba(255,255,255,.55) 0%, rgba(255,255,255,0) 55%),
    linear-gradient(240deg, rgba(255,200,120,.55) 0%, rgba(255,200,120,0) 55%),
    radial-gradient(circle, rgba(255,255,255,.22) 0, rgba(255,255,255,0) 50%);
  background-size: 55% 140%, 55% 140%, 100% 100%;
  background-position: -10% -6%, 110% -6%, center;
  animation: lightsPulse 5s ease-in-out infinite alternate;
  mix-blend-mode:screen;
  opacity:.95;
}
.d-lights::after{
  background-image:
    radial-gradient(1.5px 1.5px at 10% 80%, rgba(255,255,255,.8) 0, rgba(255,255,255,0) 60%),
    radial-gradient(2px 2px at 90% 65%, rgba(255,230,180,.85) 0, rgba(255,230,180,0) 55%);
  background-size:140px 140px, 180px 180px;
  animation: lightsDrift 12s linear infinite;
  opacity:.75;
}
@keyframes lightsPulse{
  0%{opacity:.9;filter:blur(0px)}
  100%{opacity:1;filter:blur(2.5px)}
}
@keyframes lightsDrift{
  0%{transform:translateY(0)}
  100%{transform:translateY(10%)}
}

/* Fuegos */
.d-fireworks{
  background: radial-gradient(circle at 50% 120%, rgba(0,0,0,.3) 0, rgba(0,0,0,0) 65%);
  mix-blend-mode:screen;
}
.d-fireworks::before{
  background-image:
    radial-gradient(circle, rgba(255,255,255,1) 0, rgba(255,255,255,0) 55%),
    radial-gradient(circle, rgba(255,146,146,1) 0, rgba(255,146,146,0) 50%),
    radial-gradient(circle, rgba(120,185,255,1) 0, rgba(120,185,255,0) 50%);
  background-size: 180px 180px, 220px 220px, 240px 240px;
  background-position: 12% 15%, 74% 10%, 40% 78%;
  animation: explodeA 4.5s ease-in-out infinite;
  opacity:.95;
}
.d-fireworks::after{
  background-image:
    radial-gradient(circle, rgba(255,227,130,1) 0, rgba(255,227,130,0) 50%),
    radial-gradient(circle, rgba(255,255,255,.5) 0, rgba(255,255,255,0) 70%);
  background-size: 210px 210px, 520px 520px;
  background-position: 85% 75%, 46% 40%;
  animation: explodeB 5.2s ease-in-out infinite;
  opacity:.9;
}
@keyframes explodeA{
  0%{transform:scale(.9);opacity:0}
  10%{opacity:1}
  45%{transform:scale(1.08);opacity:1}
  100%{transform:scale(1.18);opacity:0}
}
@keyframes explodeB{
  0%{transform:scale(.7);opacity:0}
  15%{opacity:1}
  55%{transform:scale(1.15);opacity:1}
  100%{transform:scale(1.25);opacity:0}
}

/* Ondas */
.d-waves{
  background:
    radial-gradient(circle at 50% 130%, rgba(212,175,55,.55) 0, rgba(212,175,55,0) 70%),
    radial-gradient(circle at -8% 25%, rgba(255,255,255,.08) 0, rgba(255,255,255,0) 55%);
  opacity:.9;
}
.d-waves::before{
  background-image:
    linear-gradient(135deg, rgba(255,255,255,.05) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.05) 50%, rgba(255,255,255,.05) 75%, transparent 75%, transparent);
  background-size:42px 42px;
  mix-blend-mode:screen;
  animation: slowwave 14s linear infinite;
  opacity:.45;
}
.d-waves::after{
  background:
    radial-gradient(circle at 10% 90%, rgba(255,209,112,.55) 0, rgba(255,209,112,0) 55%),
    radial-gradient(circle at 90% 12%, rgba(255,255,255,.15) 0, rgba(255,255,255,0) 60%);
  animation: waveGlow 12s ease-in-out infinite alternate;
  opacity:.85;
}
@keyframes slowwave{
  from{background-position:0 0}
  to{background-position:180px 180px}
}
@keyframes waveGlow{
  0%{opacity:.6}
  100%{opacity:1}
}

/* capas principales */
.layer-arts,.layer-center{position:absolute;inset:0;}
.layer-arts{z-index:8}
.safe{position:absolute;inset:18px;display:grid;place-items:center;z-index:3}
.center{display:grid;gap:10px;justify-items:center;text-align:center;width:100%}
h1{font-family:var(--title-font);font-weight:900;margin:0;line-height:1.05;color:var(--text);font-size:clamp(22px,3.6vw,44px)}
h2{margin:0;color:var(--text);opacity:.9;font-size:clamp(13px,1.7vw,20px)}
.qr{width:300px;height:300px;display:grid;place-items:center;transition:transform .04s}
.qr img{width:100%;height:100%;image-rendering:pixelated;display:block}
.logo{display:none!important}

/* im√°genes subidas */
.art{
  position:absolute;
  object-fit:contain;
  pointer-events:auto;
  touch-action:none;
  cursor:grab;
  z-index:9;
}

/* edici√≥n */
.select-mode .safe{
  z-index:4;
  pointer-events:none;
}
.select-mode #title,
.select-mode #sub,
.select-mode #qrBox,
.select-mode #frame{
  pointer-events:auto;
}
.select-mode .layer-arts{
  z-index:3;
}

/* Marco foto */
.frame{
  position:absolute;
  display:none;
  background:#000;
  border:2px solid rgba(255,255,255,.18);
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 8px 24px rgba(0,0,0,.5);
  z-index:5;
}
.frame img{width:100%;height:100%;object-fit:cover;display:block}
.frame.placeholder::before{
  content:"FOTO";
  position:absolute; inset:0; display:grid; place-items:center;
  font-weight:700; letter-spacing:.2em; opacity:.25; color:#fff;
}

/* Controles */
.ctrls{position:absolute;top:10px;right:10px;display:flex;gap:8px;z-index:10}
.btn{background:#fff;border:1px solid rgba(0,0,0,.15);color:#0b0e14;padding:8px 10px;border-radius:10px;cursor:pointer}
.viewer:fullscreen .ctrls{display:none}

/* Modo edici√≥n */
.select-mode #title,.select-mode #sub,.select-mode #qrBox,.select-mode .art,.select-mode #frame{outline:2px dashed rgba(255,255,255,.45);border-radius:12px}
#editChip{position:absolute;left:12px;top:12px;background:rgba(15,23,42,.92);border:1px solid rgba(255,255,255,.18);color:#cbd5e1;
  padding:6px 10px;border-radius:10px;z-index:11;font-size:12px;display:none}
.select-mode #editChip{display:block}
#editHint{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,.6);padding:6px 10px;border-radius:8px;z-index:11;font-size:12px}
#editChip,#editHint{pointer-events:none}

.small{font-size:12px;color:#cbd5e1}

/* BBox */
#bbox{position:absolute;z-index:12;border:2px solid #8b5cf6;border-radius:6px;display:none;pointer-events:none}
.handle{position:absolute;width:12px;height:12px;background:#fff;border:2px solid #8b5cf6;border-radius:50%;box-shadow:0 1px 2px rgba(0,0,0,.35);pointer-events:auto;cursor:nwse-resize}
.handle.n{top:-8px;left:50%;transform:translate(-50%,0);cursor:ns-resize}
.handle.s{bottom:-8px;left:50%;transform:translate(0,-50%);cursor:ns-resize}
.handle.e{right:-8px;top:50%;transform:translate(0,-50%);cursor:ew-resize}
.handle.w{left:-8px;top:50%;transform:translate(0,-50%);cursor:ew-resize}
.handle.nw{left:-8px;top:-8px;cursor:nwse-resize}
.handle.ne{right:-8px;top:-8px;cursor:nesw-resize}
.handle.sw{left:-8px;bottom:-8px;cursor:nesw-resize}
.handle.se{right:-8px;bottom:-8px;cursor:nwse-resize}

/* Timeline */
.timeline{margin-top:10px;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;background:rgba(255,255,255,.06)}
.rail{display:flex;gap:8px;overflow:auto;padding-bottom:6px}
.rail img{width:88px;height:62px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.18)}

#viewerPrev{max-width:340px}
#viewerPrev .layer-center{transform:scale(.7);transform-origin:center}

.toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%) translateY(8px);background:#0f172a;border:1px solid #0f172a;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.25s;z-index:80}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

#chooser{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);display:none;z-index:70;align-items:center;justify-content:center}
#chooser .box{background:#0f172a;border:1px solid rgba(255,255,255,.18);border-radius:14px;padding:14px;min-width:280px}
#chooser .box h3{margin:0 0 6px 0;font-size:16px}
#chooser .row{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
#chooser .box .btn{background:#fff}

/* --- Vista SOLO SUBIDA --- */
.up-only header,.up-only #pantalla,.up-only #ajustes{display:none!important}
.up-only main{max-width:520px;padding:24px 16px}
.up-only .card{border-radius:18px}
.up-only .hero{display:grid;gap:8px;justify-items:center;text-align:center;margin-bottom:10px}
.up-only h1{font-size:22px}
.up-only .note{font-size:12px;color:#cbd5e1}
.fileline{display:flex;align-items:center;gap:10px}
.filehint{font-size:12px;color:#aab3c5}

.warn{background:#3b0f0f;border:1px solid #ef4444;color:#fecaca;padding:8px 12px;border-radius:10px;margin-bottom:10px}
.disabled{opacity:.5;pointer-events:none}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">üì∏ Pantalla con QR <span class="badge">Sala <span id="roomId">‚Äî</span></span></div>
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="pantalla" type="button">Pantalla</button>
      <button class="tab" data-tab="ajustes" type="button">Ajustes</button>
    </div>
  </div>
</header>

<main>
  <!-- PANTALLA -->
  <section id="pantalla" class="pane">
    <div class="card">
      <div id="fbWarn" class="warn hidden">‚ö†Ô∏è No conectado a Firestore o permisos denegados. Revis√° Auth an√≥nimo y reglas.</div>
      <div class="viewer" id="viewer">
        <canvas id="fxMain" class="cvfx"></canvas>

        <div class="fx-design" id="fxDesignMain"></div>

        <!-- Marco foto -->
        <div id="frame" class="frame">
          <img id="photo" alt="">
        </div>

        <div class="layer-arts" id="artsMain"></div>

        <div class="safe">
          <div class="layer-center">
            <div class="center">
              <h1 id="title">¬°Sub√≠ tu foto con el QR!</h1>
              <h2 id="sub">Escane√° y sub√≠ üì≤</h2>
              <div id="qrBox" class="qr"></div>
              <img id="logo" class="logo" alt="logo">
            </div>
          </div>
        </div>

        <div id="editChip">‚úèÔ∏è Edici√≥n ‚Äî arrastr√°; manijas para escalar</div>

        <div class="ctrls">
          <button id="btnFull" class="btn" type="button">‚õ∂</button>
          <button id="btnFoto" class="btn" type="button">Foto</button>
          <button id="btnEdit" class="btn" type="button">Editar (E)</button>
          <button id="btnSave" class="btn hidden" type="button">Guardar</button>
          <button id="btnDel" class="btn hidden" type="button">Eliminar</button>
        </div>

        <div id="editHint" class="small hidden">Modo edici√≥n ‚Äî mover con drag ¬∑ escalar con manijas ¬∑ clic afuera deselecciona ¬∑ E on/off ¬∑ F (Full) ¬∑ Esc (Salir)</div>

        <!-- BBox -->
        <div id="bbox">
          <div class="handle nw" data-dir="nw"></div>
          <div class="handle n"  data-dir="n"></div>
          <div class="handle ne" data-dir="ne"></div>
          <div class="handle e"  data-dir="e"></div>
          <div class="handle se" data-dir="se"></div>
          <div class="handle s"  data-dir="s"></div>
          <div class="handle sw" data-dir="sw"></div>
          <div class="handle w"  data-dir="w"></div>
        </div>
      </div>

      <div class="timeline">
        <div class="row" style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">L√≠nea de tiempo ‚Äî <span id="count">0 fotos</span></div>
          <div class="small">Atajos: Q (QR) ¬∑ F (Full) ¬∑ E (Editar) ¬∑ Esc (Salir)</div>
        </div>
        <div id="rail" class="rail"></div>
      </div>
    </div>
  </section>

  <!-- AJUSTES -->
  <section id="ajustes" class="pane hidden">
    <div class="card">
      <div class="row" style="display:flex;justify-content:space-between;align-items:center">
        <div class="small">Editor (impacta en la pantalla)</div>
        <div class="badge">Sala <strong id="roomId2">‚Äî</strong></div>
      </div>

      <div class="row" style="display:flex;align-items:flex-start;gap:16px">
        <!-- PREVIEW -->
        <div style="flex:1;min-width:300px;max-width:460px">
          <div class="small">Previsualizaci√≥n</div>
          <div class="viewer" id="viewerPrev" style="aspect-ratio:16/9">
            <canvas id="fxPrev" class="cvfx"></canvas>
            <div class="fx-design" id="fxDesignPrev"></div>
            <div id="framePrev" class="frame" style="display:block;"></div>
            <div class="layer-arts" id="artsPrev"></div>
            <div class="safe">
              <div class="layer-center">
                <div class="center">
                  <h1 id="titlePrev">¬°Sub√≠ tu foto con el QR!</h1>
                  <h2 id="subPrev">Escane√° y sub√≠ üì≤</h2>
                  <div id="qrPrev" class="qr"></div>
                  <img id="logoPrev" class="logo" alt="logo">
                </div>
              </div>
            </div>
          </div>
          <div class="row" style="gap:8px;margin-top:10px;display:flex">
            <button id="btnQRModal" class="btn" type="button">Mostrar QR</button>
            <button id="btnReset" class="btn" type="button">Reset</button>
          </div>
        </div>

        <!-- CONTROLES -->
        <div style="flex:1.15;min-width:280px">
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">T√≠tulo</label><input id="inpTitle" type="text" value="¬°Sub√≠ tu foto con el QR!"></div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Subt√≠tulo</label><input id="inpSub" type="text" value="Escane√° y sub√≠ üì≤"></div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Tipograf√≠a</label>
            <select id="fontSel"><option value="Poppins" selected>Poppins</option><option value="Bebas Neue">Bebas Neue</option><option value="Inter">Inter</option></select>
          </div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Color fondo</label><input id="bg" type="color" value="#000000"></div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Color texto</label><input id="tx" type="color" value="#ffffff"></div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Tama√±o QR (%)</label><input id="qrPct" type="number" min="20" max="80" value="58"></div>

          <!-- selector de dise√±o -->
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0">
            <label style="min-width:140px">Dise√±o pantalla</label>
            <select id="designSel">
              <option value="none">Ninguno</option>
              <option value="stars">Estrellas</option>
              <option value="lights">Luces</option>
              <option value="fireworks">Fuegos artificiales</option>
              <option value="waves">Ondas</option>
            </select>
          </div>

          <hr style="border-color:rgba(255,255,255,.12)">

          <!-- SUBIR IMAGEN -->
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0">
            <label style="min-width:140px">Subir imagen</label>
            <div class="fileline">
              <button id="btnPickLogo" class="btn" type="button">Seleccionar archivo</button>
              <span id="logoName" class="filehint">Ning√∫n archivo seleccionado</span>
            </div>
            <input id="logoCam" type="file" accept="image/*,.svg,.webp,.avif" capture="environment" class="hidden">
            <input id="logoGal" type="file" accept="image/*,.svg,.webp,.avif" class="hidden">
          </div>

          <!-- controles de logo -->
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Altura logo (vh)</label><input id="logoVH" type="number" min="6" max="40" value="18"></div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Posici√≥n logo</label>
            <select id="logoPos"><option value="center" selected>Centro</option><option value="top-left">Arriba izq.</option><option value="top-right">Arriba der.</option><option value="bottom-left">Abajo izq.</option><option value="bottom-right">Abajo der.</option></select>
          </div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Opacidad logo (%)</label><input id="logoAlpha" type="number" min="10" max="100" value="100"></div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Mezcla logo</label>
            <select id="logoBlend"><option value="normal" selected>Normal</option><option value="screen">Screen</option><option value="multiply">Multiply</option><option value="lighten">Lighten</option><option value="darken">Darken</option></select>
          </div>

          <hr style="border-color:rgba(255,255,255,.12)">

          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0">
            <label style="min-width:140px">Duraci√≥n por foto (seg)</label>
            <input id="durSec" type="number" min="1" max="60" value="5">
          </div>
          <div class="small">Cada foto aparece una sola vez. Al terminar, vuelve el QR.</div>

          <div class="row" style="margin-top:10px">
            <button id="btnQRModal" class="btn" type="button">Mostrar QR</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SUBIR por QR -->
  <section id="upload" class="hidden">
    <div class="card">
      <div class="hero">
        <h1>Sub√≠ tu foto üì§</h1>
        <div class="note">Se enviar√° a la sala <b id="roomUp">‚Äî</b></div>
      </div>
      <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0">
        <label style="min-width:120px">Archivo</label>
        <div class="fileline">
          <button id="btnPickUp" class="btn" type="button">Seleccionar archivo</button>
          <span id="upName" class="filehint">Ning√∫n archivo seleccionado</span>
        </div>
        <input id="fileUpCam" type="file" accept="image/*,.svg,.webp,.avif,.gif" capture="environment" class="hidden">
        <input id="fileUpGal" type="file" accept="image/*,.svg,.webp,.avif,.gif" class="hidden">
      </div>
      <div class="row" style="justify-content:flex-end;display:flex;margin-top:10px">
        <button id="btnUp" class="btn" type="button">Subir</button>
      </div>
    </div>
  </section>
</main>

<div id="toast" class="toast"></div>

<!-- Modal QR -->
<div id="qrModal" class="modal" aria-hidden="true" style="position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);display:none;z-index:60">
  <div class="stage" id="qrStage" style="position:absolute;inset:24px;border-radius:16px;border:1px solid rgba(255,255,255,.18);overflow:hidden;display:grid;place-items:center;background:transparent">
    <div style="text-align:center">
      <h1 id="qrTitle">‚Äî</h1>
      <h2>Escane√° el QR para subir üì≤</h2>
      <div id="qrBig"></div>
    </div>
  </div>
</div>

<!-- Mini chooser -->
<div id="chooser">
  <div class="box">
    <h3>¬øDe d√≥nde tomamos la imagen?</h3>
    <div class="row">
      <button id="chCam" class="btn" type="button">C√°mara</button>
      <button id="chGal" class="btn" type="button">Galer√≠a</button>
      <button id="chCancel" class="btn" type="button">Cancelar</button>
    </div>
  </div>
</div>

<script type="module">
const $ = (s)=>document.querySelector(s);
const toast=(m)=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),1500);};
const enterFS=(el)=>el.requestFullscreen?.(); 
const exitFS=()=>document.exitFullscreen?.(); 
const isFS=()=>document.fullscreenElement;

/* chooser */
let chooserResolve = null;
function openChooser(){ return new Promise((res)=>{ chooserResolve=res; $("#chooser").style.display="flex"; }); }
function closeChooser(){ $("#chooser").style.display="none"; chooserResolve=null; }
$("#chCancel").onclick = ()=>{ chooserResolve?.(null); closeChooser(); };
$("#chCam").onclick    = ()=>{ chooserResolve?.("cam"); closeChooser(); };
$("#chGal").onclick    = ()=>{ chooserResolve?.("gal"); closeChooser(); };

/* tabs */
function switchTab(id){
  document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
  document.querySelector(`[data-tab="${id}"]`).classList.add("active");
  document.querySelectorAll(".pane").forEach(p=>p.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  layoutAll();
}
document.querySelectorAll("[data-tab]").forEach(b=>b.addEventListener("click",()=>switchTab(b.dataset.tab)));

/* sala */
const params = new URLSearchParams(location.search);
const uploadMode = (location.hash === "#subir");
let room = params.get("r") || localStorage.getItem("qr:sala") || (Math.random().toString(36).slice(2,8)).toUpperCase();
localStorage.setItem("qr:sala", room);
if(uploadMode){ document.body.classList.add("up-only"); $("#upload").classList.remove("hidden"); }
else{ $("#pantalla").classList.remove("hidden"); }
$("#roomId").textContent=room; $("#roomId2").textContent=room; $("#roomUp").textContent=room;

/* QR */
function buildUploadURL(){ const url=new URL(location.href); url.searchParams.set("r", room); url.hash="#subir"; return url.toString(); }
function qrImg(url, size){ const i=new Image(); i.alt="QR"; i.src=`https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&margin=0&data=${encodeURIComponent(url)}`; i.style.width="100%"; i.style.height="100%"; i.style.imageRendering="pixelated"; return i; }
function layoutQR(box, viewer, scale=1){
  const pct = Math.min(80,Math.max(20, Number($("#qrPct").value||58)));
  const side = Math.floor(Math.min(viewer.clientWidth,viewer.clientHeight) * pct / 100 * scale);
  box.style.width = side+"px"; box.style.height = side+"px";
  box.innerHTML=""; box.appendChild(qrImg(buildUploadURL(), side));
}

/* FX */
class FX{
  constructor(canvas, host){ this.cv=canvas; this.host=host; this.ctx=canvas.getContext('2d'); new ResizeObserver(()=>this.resize()).observe(host); this.resize(); requestAnimationFrame(()=>this.loop()); }
  resize(){ const r=this.host.getBoundingClientRect(); const d=Math.min(2,window.devicePixelRatio||1); this.cv.width=Math.max(1,r.width*d); this.cv.height=Math.max(1,r.height*d); this.cv.style.width=r.width+"px"; this.cv.style.height=r.height+"px"; this.ctx.setTransform(d,0,0,d,0,0);}
  loop(){ const {ctx}=this; ctx.clearRect(0,0,this.cv.width,this.cv.height); requestAnimationFrame(()=>this.loop()); }
}
new FX($("#fxMain"), $("#viewer"));
new FX($("#fxPrev"), $("#viewerPrev"));

/* ======= ESTADO (sin persistencia) ======= */
const DEFAULTS = {}; // no leemos localStorage
const S = Object.assign({
  title:"¬°Sub√≠ tu foto con el QR!", subText:"Escane√° y sub√≠ üì≤", font:"Poppins",
  bg:"#000000", text:"#ffffff", qrPct:58,
  titleOffX:0,titleOffY:0, titleScale:100,
  subOffX:0,subOffY:0, subScale:100,
  qrOffX:0, qrOffY:0, qrScale:100,
  design:"none",
  arts: [],
  frameBasePct:60, frameOffX:0, frameOffY:0, frameScale:100,
  durationSec:5,
  hideTitle:false, hideSub:false, hideQR:false, hideFrame:false
}, DEFAULTS);
let T=null; 
const ST=()=> T||S; 

/* persistencia anulada */
const persist = ()=>{}; // NO guarda nada en localStorage

/* helper: actualizar tanto S como T (memoria) */
function updateStateFor(key, changer){
  if(key==="title"){ changer(S, "title"); }
  else if(key==="sub"){ changer(S, "sub"); }
  else if(key==="qr"){ changer(S, "qr"); }
  else if(key==="frame"){ changer(S, "frame"); }
  else if(key.startsWith("art:")){
    const id = key.split(":")[1];
    const idx = (S.arts||[]).findIndex(a=>a.id===id);
    if(idx>-1){ S.arts[idx] = changer({arts:S.arts[idx]}, "art").arts; }
  }
  if(T){
    if(key==="title"){ changer(T, "title"); }
    else if(key==="sub"){ changer(T, "sub"); }
    else if(key==="qr"){ changer(T, "qr"); }
    else if(key==="frame"){ changer(T, "frame"); }
    else if(key.startsWith("art:")){
      const id = key.split(":")[1];
      const idxT = (T.arts||[]).findIndex(a=>a.id===id);
      if(idxT>-1){ T.arts[idxT] = changer({arts:T.arts[idxT]}, "art").arts; }
    }
  }
  persist();
}

/* setHidden (solo memoria) */
function setHidden(which, hidden=true){
  if(which==="title"){ S.hideTitle=hidden; if(T) T.hideTitle=hidden; }
  if(which==="sub")  { S.hideSub =hidden; if(T) T.hideSub =hidden; }
  if(which==="qr")   { S.hideQR  =hidden; if(T) T.hideQR  =hidden; }
  if(which==="frame"){ S.hideFrame=hidden; if(T) T.hideFrame=hidden; }
  persist(); layoutAll(); deselectEl();
}

/* aplicar dise√±o */
function applyDesign(where){
  const s=ST();
  const el = (where==="main") ? $("#fxDesignMain") : $("#fxDesignPrev");
  if(!el) return;
  el.className = "fx-design";
  if(s.design && s.design!=="none"){
    el.classList.add("d-"+s.design);
  }
}

/* theme */
function applyTheme(){
  document.documentElement.style.setProperty('--bg', $("#bg")?.value || S.bg);
  document.documentElement.style.setProperty('--text', $("#tx")?.value || S.text);
  document.documentElement.style.setProperty('--title-font', `"${($("#fontSel")?.value || S.font)}",system-ui,-apple-system,Segoe UI,Roboto,sans-serif`);
  const s=ST();
  if($("#inpTitle")) s.title=$("#inpTitle").value;
  if($("#inpSub"))   s.subText=$("#inpSub").value;
  if($("#fontSel"))  s.font=$("#fontSel").value;
  if($("#bg"))       s.bg=$("#bg").value;
  if($("#tx"))       s.text=$("#tx").value;
  if($("#qrPct"))    s.qrPct=Number($("#qrPct").value||58);
  if($("#designSel")) s.design=$("#designSel").value;
  if($("#durSec"))   s.durationSec=Math.max(1, Number($("#durSec").value||5));
  layoutAll();
  if(slideActive) resetSlideshow();
}
["inpTitle","inpSub","bg","tx","fontSel","qrPct","durSec","designSel"].forEach(id=>$("#"+id)?.addEventListener("input",applyTheme));

/* subir imagen local (solo memoria) */
async function openChooserFor(cam, gal){
  const sel = await openChooser();
  if(sel==="cam") cam.click();
  else if(sel==="gal") gal.click();
}
$("#btnPickLogo")?.addEventListener("click", ()=>openChooserFor($("#logoCam"), $("#logoGal")));

function pushImageToArts(url){
  const rndX = Math.floor(Math.random()*60) - 30;
  const rndY = Math.floor(Math.random()*60) - 30;
  const imgObj = {
    id:"art_"+Date.now()+"_"+Math.floor(Math.random()*9999),
    url,
    pos:"free",
    sizeVH:18,
    alpha:100,
    offX:rndX,
    offY:rndY,
    scale:100
  };
  S.arts = S.arts || [];
  S.arts.push(imgObj);
  if(T){
    T.arts = T.arts || [];
    T.arts.push({...imgObj});
  }
  persist();
}
function handleImageSelected(file){
  if(!file) return;
  $("#logoName").textContent=file.name;
  const url = URL.createObjectURL(file);
  pushImageToArts(url);
  layoutAll();
  if(!edit) setEdit(true);
  toast("Imagen subida ‚úÖ");
  $("#logoCam").value = "";
  $("#logoGal").value = "";
}
$("#logoCam").addEventListener("change",(e)=>handleImageSelected(e.target.files?.[0]));
$("#logoGal").addEventListener("change",(e)=>handleImageSelected(e.target.files?.[0]));

/* layout helpers */
function placeByPos(el,pos){
  const m="18px"; el.style.top=el.style.right=el.style.bottom=el.style.left="auto";
  if(pos==="top-left"){el.style.top=m;el.style.left=m}
  else if(pos==="top-right"){el.style.top=m;el.style.right=m}
  else if(pos==="bottom-left"){el.style.bottom=m;el.style.left=m}
  else if(pos==="bottom-right"){el.style.bottom=m;el.style.right=m}
  else {el.style.top="50%";el.style.left="50%";el.style.transform="translate(-50%,-50%)";}
}
function setTS(el, xPct, yPct, scale){ el.style.transformOrigin="center center"; el.style.transform=`translate(${xPct}%, ${yPct}%) scale(${(scale||100)/100})`; }

function layoutFrame(where){
  const s=ST();
  const viewer = where==="main" ? $("#viewer") : $("#viewerPrev");
  const frame  = where==="main" ? $("#frame")  : $("#framePrev");
  if(!viewer || !frame) return;
  const SCALE  = (where==="prev") ? .7 : 1;
  const side = Math.floor(Math.min(viewer.clientWidth, viewer.clientHeight) * (s.frameBasePct||60) / 100 * SCALE);
  frame.style.width = side+"px";
  frame.style.height= side+"px";
  setTS(frame, s.frameOffX||0, s.frameOffY||0, (s.frameScale||100)*(where==="prev"?SCALE*100:100)/100);
  if(where==="main"){
    const hasImg = $("#photo")?.src && !$("#photo").src.endsWith("#");
    frame.classList.toggle("placeholder", !hasImg);
  }
}

function layoutViewer(where){
  const s = ST();
  const viewer = where==="main" ? $("#viewer") : $("#viewerPrev");
  const title  = where==="main" ? $("#title") : $("#titlePrev");
  const sub    = where==="main" ? $("#sub") : $("#subPrev");
  const qrBox  = where==="main" ? $("#qrBox") : $("#qrPrev");
  const arts   = where==="main" ? $("#artsMain") : $("#artsPrev");
  const frame  = where==="main" ? $("#frame") : $("#framePrev");
  const SCALE  = (where==="prev") ? .7 : 1;
  if(!viewer) return;

  title.textContent=s.title; sub.textContent=s.subText;
  title.style.color=s.text;  sub.style.color=s.text;  viewer.style.background=s.bg;

  title.style.display = s.hideTitle ? "none" : "";
  sub.style.display   = s.hideSub   ? "none" : "";
  qrBox.style.display = s.hideQR    ? "none" : "";
  if(where==="prev"){ frame.style.display = s.hideFrame ? "none" : "block"; }

  applyDesign(where);

  layoutQR(qrBox, viewer, SCALE);
  setTS(qrBox, s.qrOffX||0, s.qrOffY||0, (s.qrScale||100)*(where==="prev"?SCALE*100:100)/100);
  setTS(title, s.titleOffX||0, s.titleOffY||0, (s.titleScale||100)*(where==="prev"?SCALE*100:100)/100);
  setTS(sub,   s.subOffX||0,   s.subOffY||0,   (s.subScale||100)*(where==="prev"?SCALE*100:100)/100);

  arts.innerHTML="";
  (s.arts||[]).forEach(a=>{
    const im=new Image(); 
    im.src=a.url; 
    im.className="art"; 
    im.style.height=((a.sizeVH||18)*SCALE)+"vh"; 
    im.style.opacity=(a.alpha||100)/100;
    im.dataset.artId=a.id;
    if(a.pos==="free"){
      im.style.top="0"; 
      im.style.left="0"; 
      im.style.right="auto"; 
      im.style.bottom="auto";
    }else{
      placeByPos(im,a.pos||"top-left");
    }
    arts.appendChild(im);
    setTS(im, a.offX||0, a.offY||0, (a.scale||100));
    im.addEventListener("pointerdown", onDown);
  });

  layoutFrame(where);

  if(where==="main"){
    if(s.hideFrame) frame.style.display="none";
    if(edit){ bindSelectables(true); }
  }
}
function layoutAll(){ layoutViewer("main"); layoutViewer("prev"); }
window.addEventListener("resize", layoutAll);

/* edici√≥n */
let edit=false, dragging=false, dragEl=null, selectedEl=null, startX=0, startY=0, baseX=0, baseY=0;
const bbox=$("#bbox");

function getKey(el){
  if(el?.id==="title") return "title";
  if(el?.id==="sub")   return "sub";
  if(el?.id==="qrBox") return "qr";
  if(el?.id==="frame") return "frame";
  if(el?.classList?.contains("art")) return "art:"+el.dataset.artId;
  return "";
}
function getOffsets(key){
  const s=ST();
  const target = T || S;
  if(key==="title") return {x:s.titleOffX||0,y:s.titleOffY||0,sc:s.titleScale||100,set:(x,y,sc)=>{target.titleOffX=x;target.titleOffY=y;if(sc!=null)target.titleScale=sc;}};
  if(key==="sub")   return {x:s.subOffX||0,y:s.subOffY||0,sc:s.subScale||100,set:(x,y,sc)=>{target.subOffX=x;target.subOffY=y;if(sc!=null)target.subScale=sc;}};
  if(key==="qr")    return {x:s.qrOffX||0,y:s.qrOffY||0,sc:s.qrScale||100,set:(x,y,sc)=>{target.qrOffX=x;target.qrOffY=y;if(sc!=null)target.qrScale=sc;}};
  if(key==="frame") return {x:s.frameOffX||0,y:s.frameOffY||0,sc:s.frameScale||100,set:(x,y,sc)=>{target.frameOffX=x;target.frameOffY=y;if(sc!=null)target.frameScale=sc;}};
  if(key.startsWith("art:")){
    const id=key.split(":")[1]; 
    const a=(s.arts||[]).find(v=>v.id===id)||{offX:0,offY:0,scale:100};
    return {
      x:a.offX||0,
      y:a.offY||0,
      sc:a.scale||100,
      set:(x,y,sc)=>{
        const list = target.arts || [];
        const j=list.findIndex(z=>z.id===id);
        if(j>-1){
          list[j]={...list[j],offX:x,offY:y,scale:(sc!=null?sc:list[j].scale||100)};
        }
        target.arts = list;
      }
    };
  }
  return {x:0,y:0,sc:100,set:()=>{}};
}

function showBBox(el){ bbox.style.display="block"; positionBBox(el); }
function hideBBox(){ bbox.style.display="none"; }
function positionBBox(el){
  const r=el.getBoundingClientRect(), host=$("#viewer").getBoundingClientRect();
  bbox.style.left=(r.left-host.left)+"px";
  bbox.style.top =(r.top -host.top )+"px";
  bbox.style.width = r.width+"px";
  bbox.style.height= r.height+"px";
}
function selectEl(el){
  if(!el) return;
  selectedEl = el;
  document.querySelectorAll(".is-sel").forEach(n=>n.classList.remove("is-sel"));
  el.classList.add("is-sel");
  showBBox(el);
}
function deselectEl(){
  if(!selectedEl) return;
  selectedEl.classList.remove("is-sel");
  selectedEl = null;
  hideBBox();
}

$("#viewer").addEventListener("pointerdown",(e)=>{
  if(!edit) return;
  const inside = e.target.closest("#title,#sub,#qrBox,#frame,.art,#bbox");
  if(!inside){ deselectEl(); }
},{capture:true});

function bindSelectables(on){
  const els=[$("#title"),$("#sub"),$("#qrBox"),$("#frame"),...$("#artsMain").querySelectorAll(".art")];
  els.forEach(el=>{
    if(!el) return;
    if(el.style.display==="none") return;
    el.style.pointerEvents = on ? "auto" : el.classList.contains("art") ? "auto" : "none";
    el.removeEventListener("pointerdown", onDown);
    if(on) el.addEventListener("pointerdown", onDown);
  });
}

function onDown(e){
  if(!edit && !e.currentTarget.classList.contains("art")) return;
  dragEl=e.currentTarget; dragging=true;
  dragEl.setPointerCapture?.(e.pointerId);
  selectEl(dragEl);
  const st=getOffsets(getKey(dragEl));
  baseX=st.x||0; baseY=st.y||0; startX=e.clientX; startY=e.clientY;
  window.addEventListener("pointermove", onMove);
  window.addEventListener("pointerup", onUp, {once:true});
  window.addEventListener("pointercancel", onUp, {once:true});
}

function onMove(e){
  if(!dragging || !dragEl) return;
  const view=$("#viewer").getBoundingClientRect();
  const hw=view.width/2, hh=view.height/2;
  const dx=e.clientX-startX, dy=e.clientY-startY;
  const nx = baseX + (dx/hw)*100;
  const ny = baseY + (dy/hh)*100;
  const sc = (/scale\(([\d.]+)\)/.exec(getComputedStyle(dragEl).transform)?.[1]||1);
  dragEl.style.transform=`translate(${nx}%, ${ny}%) scale(${sc})`;
  positionBBox(dragEl);
}

function finishDrop(){
  if(!dragEl) return;
  const key = getKey(dragEl);
  const style=dragEl.style.transform || getComputedStyle(dragEl).transform;
  const view=$("#viewer").getBoundingClientRect();
  let xPct=baseX, yPct=baseY;
  const mPct=/translate\(([-\d.]+)%?,\s*([-\d.]+)%?\)/.exec(dragEl.style.transform);
  if(mPct && dragEl.style.transform.includes("%")){
    xPct=parseFloat(mPct[1]||0); yPct=parseFloat(mPct[2]||0);
  }else{
    const mPx=/matrix\([^,]+,[^,]+,[^,]+,[^,]+,([-\d.]+),([-\d.]+)\)/.exec(getComputedStyle(dragEl).transform);
    if(mPx){
      const px=parseFloat(mPx[1]||0), py=parseFloat(mPx[2]||0);
      xPct=(px/(view.width/2))*100; yPct=(py/(view.height/2))*100;
    }
  }
  const scMatch=/scale\(([\d.]+)\)/.exec(style);
  const sc = scMatch ? Math.round(parseFloat(scMatch[1])*100) : getOffsets(key).sc||100;

  const dist = Math.hypot(xPct-baseX, yPct-baseY);
  if(dist < 0.3){
    dragging=false;
    dragEl=null;
    return;
  }

  updateStateFor(key, (obj)=>{
    if(key==="title"){ obj.titleOffX = xPct; obj.titleOffY = yPct; obj.titleScale = sc; return obj; }
    if(key==="sub")  { obj.subOffX   = xPct; obj.subOffY   = yPct; obj.subScale   = sc; return obj; }
    if(key==="qr")   { obj.qrOffX    = xPct; obj.qrOffY    = yPct; obj.qrScale    = sc; return obj; }
    if(key==="frame"){ obj.frameOffX = xPct; obj.frameOffY = yPct; obj.frameScale = sc; return obj; }
    if(key.startsWith("art:")){ return { arts: { ...obj.arts, offX:xPct, offY:yPct, scale:sc } }; }
    return obj;
  });

  dragging=false;
  positionBBox(dragEl);
  dragEl=null;
}
function onUp(){ finishDrop(); }

/* resize handles */
let resizing=false, resizeDir="", startScale=100, startWH={w:0,h:0}, startTX=0, startTY=0;
$("#bbox").querySelectorAll(".handle").forEach(h=>{
  h.addEventListener("pointerdown",(e)=>{
    if(!edit || !selectedEl) return;
    e.stopPropagation(); e.preventDefault();
    dragEl = selectedEl;
    const k=getKey(dragEl); const st=getOffsets(k);
    startScale=st.sc||100; startWH={w:dragEl.getBoundingClientRect().width, h:dragEl.getBoundingClientRect().height};
    const tr = /translate\(([-\d.]+)%?,\s*([-\d.]+)%?\)/.exec(dragEl.style.transform) || [0,0,st.x||0,st.y||0];
    startTX=parseFloat(tr[1]||st.x||0);
    startTY=parseFloat(tr[2]||st.y||0);
    startX=e.clientX; startY=e.clientY;
    resizing=true; resizeDir=e.currentTarget.dataset.dir;
    window.addEventListener("pointermove", onResizeMove);
    window.addEventListener("pointerup", endResize, {once:true});
    window.addEventListener("pointercancel", endResize, {once:true});
  });
});
function onResizeMove(e){
  if(!resizing || !dragEl) return;
  const dx=e.clientX-startX, dy=e.clientY-startY;
  const relX = (resizeDir.includes("e")? dx : resizeDir.includes("w")? -dx : 0) / Math.max(40,startWH.w);
  const relY = (resizeDir.includes("s")? dy : resizeDir.includes("n")? -dy : 0) / Math.max(40,startWH.h);
  const rel  = (Math.abs(relX)>Math.abs(relY)? relX : relY);
  let newScale = Math.max(10, Math.min(400, Math.round((startScale*(1+rel))*1)));
  dragEl.style.transform=`translate(${startTX}%, ${startTY}%) scale(${newScale/100})`;
  positionBBox(dragEl);
  const key = getKey(dragEl);

  updateStateFor(key, (obj)=>{
    if(key==="title"){ obj.titleOffX = startTX; obj.titleOffY = startTY; obj.titleScale = newScale; return obj; }
    if(key==="sub")  { obj.subOffX   = startTX; obj.subOffY   = startTY; obj.subScale   = newScale; return obj; }
    if(key==="qr")   { obj.qrOffX    = startTX; obj.qrOffY    = startTY; obj.qrScale    = newScale; return obj; }
    if(key==="frame"){ obj.frameOffX = startTX; obj.frameOffY = startTY; obj.frameScale = newScale; return obj; }
    if(key.startsWith("art:")){ return { arts: { ...obj.arts, offX:startTX, offY:startTY, scale:newScale } }; }
    return obj;
  });
}
function endResize(){ resizing=false; dragEl=null; }

/* eliminar imagen subida (local) */
function removeArtById(id){
  S.arts = (S.arts || []).filter(a=>a.id!==id);
  if(T && T.arts){ T.arts = T.arts.filter(a=>a.id!==id); }
  persist();
  layoutAll();
}

/* Eliminar seleccionado */
$("#btnDel").addEventListener("click", ()=>{
  if(!edit) { toast("Activ√° edici√≥n primero"); return; }
  if(!selectedEl){ toast("Seleccion√° un objeto"); return; }
  const key = getKey(selectedEl);

  if(key.startsWith("art:")){
    const id = key.split(":")[1];
    selectedEl.remove();
    removeArtById(id);
    deselectEl();
    toast("Imagen eliminada üóëÔ∏è");
    return;
  }
  if(key==="title"){ setHidden("title", true); toast("T√≠tulo eliminado üóëÔ∏è"); return; }
  if(key==="sub")  { setHidden("sub",   true); toast("Subt√≠tulo eliminado üóëÔ∏è"); return; }
  if(key==="qr")   { setHidden("qr",    true); toast("QR eliminado üóëÔ∏è"); return; }
  if(key==="frame"){ setHidden("frame", true); toast("Marco de foto eliminado üóëÔ∏è"); return; }

  toast("Nada para eliminar");
});

/* modo edici√≥n */
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
function setEdit(on){
  if(on===edit) return;
  edit=on;
  if(edit){
    T = deepClone(S);
    $("#viewer").classList.add("select-mode");
    $("#btnEdit").classList.add("hidden"); 
    $("#btnSave").classList.remove("hidden");
    $("#btnDel").classList.remove("hidden");
    $("#editHint").classList.remove("hidden"); 
    $("#editChip").style.display="block";
    bindSelectables(true);
  }else{
    hideBBox();
    T && Object.assign(S, T);
    T=null; dragging=false; dragEl=null; selectedEl=null; resizing=false;
    $("#viewer").classList.remove("select-mode");
    $("#btnEdit").classList.remove("hidden"); 
    $("#btnSave").classList.add("hidden");
    $("#btnDel").classList.add("hidden");
    $("#editHint").classList.add("hidden"); 
    $("#editChip").style.display="none";
    bindSelectables(false); 
    persist(); 
    layoutAll();
    $("#frame").style.display="none";
  }
}
$("#btnEdit").addEventListener("click",()=>setEdit(true));
$("#btnSave").addEventListener("click",()=>{ setEdit(false); toast("Cambios guardados (solo esta sesi√≥n) ‚úÖ"); });

/* Foto toggle */
function ensureFrameVisible(select=false){
  const f=$("#frame");
  if(ST().hideFrame) return;
  f.style.display="block";
  const hasImg = $("#photo")?.src && !$("#photo").src.endsWith("#");
  f.classList.toggle("placeholder", !hasImg);
  if(select){ selectEl(f); }
}
$("#btnFoto")?.addEventListener("click", ()=>{
  const f=$("#frame");
  if(!edit){
    setEdit(true);
    ensureFrameVisible(true);
    return;
  }
  if(ST().hideFrame){
    toast("El marco est√° eliminado. Us√° Reset para restaurar.");
    return;
  }
  const isVisible = f.style.display!=="none";
  if(isVisible){
    f.style.display="none";
    deselectEl();
    toast("Foto ocultada ‚úÖ");
  }else{
    ensureFrameVisible(true);
    toast("Foto mostrada ‚úÖ");
  }
});

/* Modal QR / Fullscreen / atajos */
const modal=$("#qrModal"), stage=$("#qrStage"), qrBig=$("#qrBig");
function openQR(){ if(location.hash==="#subir") return;
  if(ST().hideQR){ toast("El QR est√° eliminado."); return; }
  modal.style.display="block";
  const s=Math.floor(Math.min(stage.clientWidth,stage.clientHeight)*0.66);
  qrBig.innerHTML=""; qrBig.appendChild(qrImg(buildUploadURL(), s));
  stage.requestFullscreen?.(); $("#qrTitle").textContent=ST().title||"‚Äî";
}
function closeQR(){ modal.style.display="none"; if(isFS()) exitFS(); }
$("#btnQRModal")?.addEventListener("click", openQR);
modal?.addEventListener("click",(e)=>{ if(e.target===modal) closeQR(); });
$("#btnFull")?.addEventListener("click", ()=>{ if(isFS()) exitFS(); else enterFS($("#viewer")); });
document.addEventListener("keydown",(e)=>{
  if(["KeyF","Escape","KeyE","KeyQ"].includes(e.code)) e.preventDefault();
  if(e.code==="KeyF"){ if(isFS()) exitFS(); else enterFS($("#viewer")); }
  if(e.code==="KeyE"){ setEdit(!edit); }
  if(e.code==="KeyQ"){ openQR(); }
  if(e.code==="Escape"){ if(edit){ setEdit(false); } else if(isFS()) exitFS(); }
},{capture:true,passive:false});

/* inicial */
function applyInitial(){
  $("#inpTitle") && ($("#inpTitle").value=S.title);
  $("#inpSub")   && ($("#inpSub").value=S.subText);
  $("#fontSel")  && ($("#fontSel").value=S.font);
  $("#bg")       && ($("#bg").value=S.bg);
  $("#tx")       && ($("#tx").value=S.text);
  $("#qrPct")    && ($("#qrPct").value=S.qrPct);
  $("#designSel") && ($("#designSel").value=S.design || "none");
  $("#durSec")   && ($("#durSec").value=S.durationSec);
  $("#roomId").textContent=room; $("#roomId2").textContent=room; $("#roomUp").textContent=room;
  layoutAll();
}
applyInitial();

$("#btnReset")?.addEventListener("click", ()=>{ location.reload(); });

/* compresi√≥n */
async function fileToCompressedDataURL(file, maxSide=1600, quality=0.78){
  const bitmap = await createImageBitmap(file);
  const {width: w, height: h} = bitmap;
  let nw=w, nh=h;
  if (Math.max(w,h) > maxSide){
    const ratio = w>h ? maxSide/w : maxSide/h;
    nw = Math.round(w*ratio); nh = Math.round(h*ratio);
  }
  const cv = document.createElement('canvas');
  cv.width = nw; cv.height = nh;
  const ctx = cv.getContext('2d');
  ctx.drawImage(bitmap, 0, 0, nw, nh);
  let q = quality, dataURL = cv.toDataURL('image/jpeg', q);
  while (dataURL.length > 900*1024 && q > 0.5){
    q -= 0.08;
    dataURL = cv.toDataURL('image/jpeg', q);
  }
  return dataURL;
}

/* slideshow (solo QR) */
let shownIds = new Set();
let queue    = [];
let slideIndex = 0;
let slideTimer = null;
let slideActive = false;
function showCenter(on){ const allow = on && !ST().hideQR; $("#qrBox").parentElement.style.display = allow ? "grid" : "none"; }
function showFrame(on){ const allow = on && !ST().hideFrame; $("#frame").style.display = allow ? "block" : "none"; }
function showPhoto(src){
  if(ST().hideFrame){
    showCenter(true);
    return;
  }
  const ph=$("#photo");
  ph.src=src || "#";
  ph.onload=()=>{ $("#frame").classList.remove("placeholder"); showCenter(false); showFrame(true); };
}
function endShow(){
  showFrame(false); showCenter(true);
  slideActive=false; clearTimeout(slideTimer); slideTimer=null;
}
function runQueue(){
  if(slideIndex >= queue.length){
    queue = []; slideIndex = 0; endShow(); return;
  }
  const p = queue[slideIndex];
  const src = p.b64 || p.url;
  shownIds.add(p.id);
  showPhoto(src);
  const dur = Math.max(1, Number(ST().durationSec||5));
  clearTimeout(slideTimer);
  slideTimer = setTimeout(()=>{ slideIndex++; runQueue(); }, dur*1000);
}
function startSlideshow(){
  if(uploadMode) return;
  if(!queue.length){ endShow(); return; }
  slideActive=true; slideIndex=0; runQueue();
}
function resetSlideshow(){
  clearTimeout(slideTimer); slideTimer=null; startSlideshow();
}

/* firebase */
let fb = { ok:false };
let selectedUpFile=null;
async function initFirebase(){
  try{
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js");
    const { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, getDocs, deleteDoc } =
      await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js");
    const { getAuth, signInAnonymously, onAuthStateChanged } =
      await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js");

    const firebaseConfig = {
      apiKey: "AIzaSyBL7pLPNImcTCg4wlO5N1i426hEf3MevUg",
      authDomain: "qr-proyector.firebaseapp.com",
      projectId: "qr-proyector",
      storageBucket: "qr-proyector.appspot.com",
      messagingSenderId: "1056308881873",
      appId: "1:1056308881873:web:c48321a62c1597f3ffd8f0",
      measurementId: "G-7634GLJM1F"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    await new Promise((resolve)=>{
      onAuthStateChanged(auth, (u)=>{ if(u) return resolve(); signInAnonymously(auth).finally(resolve); });
    });

    const col = collection(db, `rooms/${room}/photos`);

    /* limpiar fotos del QR al entrar (para que no queden de sesiones previas) */
    try{
      const snap = await getDocs(col);
      const dels = [];
      snap.forEach(docSnap=>{
        dels.push(deleteDoc(docSnap.ref));
      });
      await Promise.all(dels);
    }catch(e){
      console.warn("No se pudo limpiar las fotos viejas de Firestore:", e);
    }

    fb = { ok:true, addDoc, serverTimestamp, onSnapshot, query, orderBy, col };

    $("#fbWarn").classList.add("hidden");

    fb.onSnapshot(fb.query(fb.col, fb.orderBy("createdAt","asc")), (snap)=>{
      const docs=[];
      snap.forEach(d=>docs.push({ id:d.id, ...d.data() }));

      $("#count").textContent=`${docs.length} foto${docs.length===1?"":"s"}`;
      const r=$("#rail"); r.innerHTML="";
      docs.forEach((p)=>{ const im=new Image(); im.src=p.b64 || p.url; im.alt="Foto"; r.appendChild(im); });

      const fresh = docs.filter(d=>!shownIds.has(d.id));
      if(fresh.length){
        queue.push(...fresh);
        if(!slideActive) startSlideshow();
      }
    });

    $("#btnPickUp")?.addEventListener("click", ()=>openChooserFor($("#fileUpCam"), $("#fileUpGal")));
    $("#fileUpCam").addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if(!f) return; selectedUpFile=f; $("#upName").textContent=f.name; });
    $("#fileUpGal").addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if(!f) return; selectedUpFile=f; $("#upName").textContent=f.name; });

    $("#btnUp")?.addEventListener("click", async ()=>{
      const f=selectedUpFile;
      if(!f){ toast("Eleg√≠ un archivo primero"); return; }
      try{
        const b64 = await fileToCompressedDataURL(f, 1600, 0.78);
        await fb.addDoc(col,{ b64, createdAt: fb.serverTimestamp(), name: f.name||"foto" });
        selectedUpFile=null; $("#upName").textContent="Ning√∫n archivo seleccionado";
        toast("Foto subida ‚úÖ");
      }catch(e){
        console.error(e);
        toast(e?.code==='permission-denied'?'Permiso denegado üîí':'Error al subir');
      }
    });

  }catch(err){
    console.error("Firestore no inicializado:", err);
    $("#fbWarn").classList.remove("hidden");
    ["btnUp"].forEach(id=>document.getElementById(id)?.classList.add("disabled"));
  }
}
initFirebase();

/* visibilidad inicial */
function initialVisibility(){ 
  // Siempre empezar con QR visible y sin foto
  $("#photo").src = "#";
  $("#frame").style.display="none";
  $("#frame").classList.add("placeholder");
  $("#title").style.display="";
  $("#sub").style.display="";
  $("#qrBox").style.display="";
  showCenter(true); 
}
initialVisibility();
</script>
</body>
</html>
