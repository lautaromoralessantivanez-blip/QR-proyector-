<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Pantalla con QR ‚Äî Edici√≥n + Subida remota</title>

<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;700;900&family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">

<style>
:root{ --bg:#000; --text:#fff; --title-font:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
*{box-sizing:border-box}
body{margin:0;background:#0b0e14;color:#fff;font-family:"Poppins",system-ui}
.hidden{display:none}

/* Header / layout */
header{position:sticky;top:0;z-index:5;background:rgba(0,0,0,.5);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.08)}
.wrap{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
.badge{font-size:12px;padding:4px 8px;border:1px solid rgba(255,255,255,.18);border-radius:999px;color:#cbd5e1}
.tabs{display:flex;gap:8px}
.tab{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#e2e8f0;cursor:pointer}
.tab.active{background:rgba(255,255,255,.14)}
main{max-width:1100px;margin:0 auto;padding:18px 16px 56px}
.card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px}

/* Viewer */
.viewer{width:100%;aspect-ratio:16/9;background:var(--bg);border:1px solid rgba(255,255,255,.12);border-radius:16px;position:relative;overflow:hidden}
.viewer:fullscreen{width:100vw;height:100vh;aspect-ratio:auto;border-radius:0;border:none}
.cvfx{position:absolute;inset:0;z-index:1;pointer-events:none}
.layer-arts,.layer-center{position:absolute;inset:0;z-index:2}
.safe{position:absolute;inset:18px;display:grid;place-items:center}
.center{display:grid;gap:10px;justify-items:center;text-align:center;width:100%}
h1{font-family:var(--title-font);font-weight:900;margin:0;line-height:1.05;color:var(--text);font-size:clamp(22px,3.6vw,44px)}
h2{margin:0;color:var(--text);opacity:.9;font-size:clamp(13px,1.7vw,20px)}
.qr{width:300px;height:300px;display:grid;place-items:center;transition:transform .04s}
.qr img{width:100%;height:100%;image-rendering:pixelated;display:block}
.logo{max-width:none;max-height:none;object-fit:contain;display:none}
.art{position:absolute;object-fit:contain}
.photo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none;z-index:0}

/* Controles flotantes */
.ctrls{position:absolute;top:10px;right:10px;display:flex;gap:8px;z-index:6}
.btn{background:#fff;border:1px solid rgba(0,0,0,.15);color:#0b0e14;padding:8px 10px;border-radius:10px;cursor:pointer}
.viewer:fullscreen .ctrls{display:none}

/* Modo edici√≥n */
.select-mode #title,.select-mode #sub,.select-mode #qrBox,.select-mode #logo,.select-mode .art{outline:2px dashed rgba(255,255,255,.45);border-radius:12px}
#editChip{position:absolute;left:12px;top:12px;background:rgba(15,23,42,.92);border:1px solid rgba(255,255,255,.18);color:#cbd5e1;
  padding:6px 10px;border-radius:10px;z-index:7;font-size:12px;display:none}
.select-mode #editChip{display:block}
#editHint{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,.6);padding:6px 10px;border-radius:8px;z-index:7;font-size:12px}
.small{font-size:12px;color:#cbd5e1}

/* Bounding Box tipo Canva */
#bbox{position:absolute;z-index:9;border:2px solid #8b5cf6;border-radius:6px;display:none;pointer-events:none}
.handle{position:absolute;width:12px;height:12px;background:#fff;border:2px solid #8b5cf6;border-radius:50%;box-shadow:0 1px 2px rgba(0,0,0,.35);pointer-events:auto;cursor:nwse-resize}
.handle.n{top:-8px;left:50%;transform:translate(-50%,0);cursor:ns-resize}
.handle.s{bottom:-8px;left:50%;transform:translate(-50%,0);cursor:ns-resize}
.handle.e{right:-8px;top:50%;transform:translate(0,-50%);cursor:ew-resize}
.handle.w{left:-8px;top:50%;transform:translate(0,-50%);cursor:ew-resize}
.handle.nw{left:-8px;top:-8px;cursor:nwse-resize}
.handle.ne{right:-8px;top:-8px;cursor:nesw-resize}
.handle.sw{left:-8px;bottom:-8px;cursor:nesw-resize}
.handle.se{right:-8px;bottom:-8px;cursor:nwse-resize}

/* Timeline */
.timeline{margin-top:10px;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;background:rgba(255,255,255,.06)}
.rail{display:flex;gap:8px;overflow:auto;padding-bottom:6px}
.rail img{width:88px;height:62px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.18)}

/* Preview en Ajustes (mini) */
#viewerPrev{max-width:340px}
#viewerPrev .layer-center{transform:scale(.7);transform-origin:center}

/* Toast */
.toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%) translateY(8px);background:#0f172a;border:1px solid #0f172a;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.25s;z-index:80}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* Chooser mini modal */
#chooser{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);display:none;z-index:70;align-items:center;justify-content:center}
#chooser .box{background:#0f172a;border:1px solid rgba(255,255,255,.18);border-radius:14px;padding:14px;min-width:280px}
#chooser .box h3{margin:0 0 6px 0;font-size:16px}
#chooser .row{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
#chooser .box .btn{background:#fff}

/* --- Vista SOLO SUBIDA (#subir) --- */
.up-only header,.up-only #pantalla,.up-only #ajustes{display:none!important}
.up-only main{max-width:520px;padding:24px 16px}
.up-only .card{border-radius:18px}
.up-only .hero{display:grid;gap:8px;justify-items:center;text-align:center;margin-bottom:10px}
.up-only h1{font-size:22px}
.up-only .note{font-size:12px;color:#cbd5e1}
.fileline{display:flex;align-items:center;gap:10px}
.filehint{font-size:12px;color:#aab3c5}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">üì∏ Pantalla con QR <span class="badge">Sala <span id="roomId">‚Äî</span></span></div>
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="pantalla" type="button">Pantalla</button>
      <button class="tab" data-tab="ajustes" type="button">Ajustes</button>
    </div>
  </div>
</header>

<main>
  <!-- ===== PANTALLA ===== -->
  <section id="pantalla" class="pane">
    <div class="card">
      <div class="viewer" id="viewer">
        <canvas id="fxMain" class="cvfx"></canvas>
        <img id="photo" class="photo" alt="">
        <div class="layer-arts" id="artsMain"></div>

        <div class="safe">
          <div class="layer-center">
            <div class="center">
              <h1 id="title">¬°Sub√≠ tu foto con el QR!</h1>
              <h2 id="sub">Escane√° y sub√≠ üì≤</h2>
              <div id="qrBox" class="qr"></div>
              <img id="logo" class="logo" alt="logo">
            </div>
          </div>
        </div>

        <div id="editChip">‚úèÔ∏è Edici√≥n ‚Äî arrastr√°; clic suelta ¬∑ Guardar fija</div>

        <div class="ctrls">
          <button id="btnFull" class="btn" type="button">‚õ∂</button>
          <button id="btnQR" class="btn" type="button">QR</button>
          <button id="btnEdit" class="btn" type="button">Editar (E)</button>
          <button id="btnSave" class="btn hidden" type="button">Guardar</button>
        </div>

        <div id="editHint" class="small hidden">Modo edici√≥n ‚Äî clic y arrastr√° para mover ¬∑ Clic fuera suelta ¬∑ Manijas para escalar ¬∑ E on/off ¬∑ F fullscreen ¬∑ Esc salir</div>

        <!-- Bounding box + 8 manijas -->
        <div id="bbox">
          <div class="handle nw" data-dir="nw"></div>
          <div class="handle n"  data-dir="n"></div>
          <div class="handle ne" data-dir="ne"></div>
          <div class="handle e"  data-dir="e"></div>
          <div class="handle se" data-dir="se"></div>
          <div class="handle s"  data-dir="s"></div>
          <div class="handle sw" data-dir="sw"></div>
          <div class="handle w"  data-dir="w"></div>
        </div>
      </div>

      <div class="timeline">
        <div class="row" style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">L√≠nea de tiempo ‚Äî <span id="count">0 fotos</span></div>
          <div class="small">Atajos: Q (QR) ¬∑ F (Full) ¬∑ E (Editar) ¬∑ Esc (Salir)</div>
        </div>
        <div id="rail" class="rail"></div>
      </div>
    </div>
  </section>

  <!-- ===== AJUSTES (con PREVIEW) ===== -->
  <section id="ajustes" class="pane hidden">
    <div class="card">
      <div class="row" style="display:flex;justify-content:space-between;align-items:center">
        <div class="small">Editor (impacta en la pantalla)</div>
        <div class="badge">Sala <strong id="roomId2">‚Äî</strong></div>
      </div>

      <div class="row" style="display:flex;align-items:flex-start;gap:16px">
        <!-- PREVIEW -->
        <div style="flex:1;min-width:300px;max-width:460px">
          <div class="small">Previsualizaci√≥n</div>
          <div class="viewer" id="viewerPrev" style="aspect-ratio:16/9">
            <canvas id="fxPrev" class="cvfx"></canvas>
            <img id="photoPrev" class="photo" alt="">
            <div class="layer-arts" id="artsPrev"></div>
            <div class="safe">
              <div class="layer-center">
                <div class="center">
                  <h1 id="titlePrev">¬°Sub√≠ tu foto con el QR!</h1>
                  <h2 id="subPrev">Escane√° y sub√≠ üì≤</h2>
                  <div id="qrPrev" class="qr"></div>
                  <img id="logoPrev" class="logo" alt="logo">
                </div>
              </div>
            </div>
          </div>
          <div class="row" style="gap:8px;margin-top:10px;display:flex">
            <button id="btnQRModal" class="btn" type="button">Mostrar QR (modal)</button>
            <button id="btnReset" class="btn" type="button">Reset</button>
          </div>
        </div>

        <!-- CONTROLES -->
        <div style="flex:1.15;min-width:280px">
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">T√≠tulo</label><input id="inpTitle" type="text" value="¬°Sub√≠ tu foto con el QR!"></div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Subt√≠tulo</label><input id="inpSub" type="text" value="Escane√° y sub√≠ üì≤"></div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Tipograf√≠a</label>
            <select id="fontSel"><option value="Poppins" selected>Poppins</option><option value="Bebas Neue">Bebas Neue</option><option value="Inter">Inter</option></select>
          </div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Color fondo</label><input id="bg" type="color" value="#000000"></div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Color texto</label><input id="tx" type="color" value="#ffffff"></div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Tama√±o QR (%)</label><input id="qrPct" type="number" min="20" max="80" value="58"></div>

          <hr style="border-color:rgba(255,255,255,.12)">
          <!-- LOGO -->
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0">
            <label style="min-width:140px">Logo</label>
            <div class="fileline">
              <button id="btnPickLogo" class="btn" type="button">Seleccionar archivo</button>
              <span id="logoName" class="filehint">Ning√∫n archivo seleccionado</span>
            </div>
            <input id="logoCam" type="file" accept="image/*,.svg,.webp,.avif" capture="environment" class="hidden">
            <input id="logoGal" type="file" accept="image/*,.svg,.webp,.avif" class="hidden">
          </div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Altura logo (vh)</label><input id="logoVH" type="number" min="6" max="40" value="18"></div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Posici√≥n logo</label>
            <select id="logoPos"><option value="center" selected>Centro</option><option value="top-left">Arriba izq.</option><option value="top-right">Arriba der.</option><option value="bottom-left">Abajo izq.</option><option value="bottom-right">Abajo der.</option></select>
          </div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Opacidad logo (%)</label><input id="logoAlpha" type="number" min="10" max="100" value="100"></div>
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0"><label style="min-width:140px">Mezcla logo</label>
            <select id="logoBlend"><option value="normal" selected>Normal</option><option value="screen">Screen</option><option value="multiply">Multiply</option><option value="lighten">Lighten</option><option value="darken">Darken</option></select>
          </div>

          <!-- SUBIR ART√çCULO -->
          <hr style="border-color:rgba(255,255,255,.12)">
          <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0">
            <label style="min-width:140px">Subir art√≠culo</label>
            <div class="fileline">
              <button id="btnPickArt" class="btn" type="button">Seleccionar archivo</button>
              <span id="artName" class="filehint">Ning√∫n archivo seleccionado</span>
              <button id="btnArtUpload" class="btn" type="button">Subir art√≠culo</button>
            </div>
            <input id="artCam" type="file" accept="image/*,.svg,.webp,.avif" capture="environment" class="hidden">
            <input id="artGal" type="file" accept="image/*,.svg,.webp,.avif" class="hidden">
          </div>
          <div class="small">El art√≠culo se agrega como decoraci√≥n movible; edit√° su posici√≥n/tama√±o en ‚ÄúEditar (E)‚Äù.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== SUBIR (desde QR) ===== -->
  <section id="upload" class="hidden">
    <div class="card">
      <div class="hero">
        <h1>Sub√≠ tu foto üì§</h1>
        <div class="note">Se enviar√° a la pantalla de la sala <b id="roomUp">‚Äî</b></div>
      </div>

      <div class="row" style="display:flex;gap:12px;align-items:center;margin:10px 0">
        <label style="min-width:120px">Archivo</label>
        <div class="fileline">
          <button id="btnPickUp" class="btn" type="button">Seleccionar archivo</button>
          <span id="upName" class="filehint">Ning√∫n archivo seleccionado</span>
        </div>
        <input id="fileUpCam" type="file" accept="image/*,.svg,.webp,.avif,.gif" capture="environment" class="hidden">
        <input id="fileUpGal" type="file" accept="image/*,.svg,.webp,.avif,.gif" class="hidden">
      </div>

      <div class="row" style="justify-content:flex-end;display:flex;margin-top:10px">
        <button id="btnUp" class="btn" type="button">Subir</button>
      </div>
    </div>
  </section>
</main>

<div id="toast" class="toast"></div>

<!-- Modal QR -->
<div id="qrModal" class="modal" aria-hidden="true" style="position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);display:none;z-index:60">
  <div class="stage" id="qrStage" style="position:absolute;inset:24px;border-radius:16px;border:1px solid rgba(255,255,255,.18);overflow:hidden;display:grid;place-items:center;background:transparent">
    <div style="text-align:center">
      <h1 id="qrTitle">‚Äî</h1>
      <h2>Escane√° el QR para subir üì≤</h2>
      <div id="qrBig"></div>
    </div>
  </div>
</div>

<!-- Mini chooser C√°mara/Galer√≠a -->
<div id="chooser">
  <div class="box">
    <h3>¬øDe d√≥nde tomamos la imagen?</h3>
    <div class="row">
      <button id="chCam" class="btn" type="button">C√°mara</button>
      <button id="chGal" class="btn" type="button">Galer√≠a</button>
      <button id="chCancel" class="btn" type="button">Cancelar</button>
    </div>
  </div>
</div>

<script type="module">
/* ===== Utilidades ===== */
const $ = (s)=>document.querySelector(s);
const toast=(m)=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),1500);};
const enterFS=(el)=>el.requestFullscreen?.(); const exitFS=()=>document.exitFullscreen?.(); const isFS=()=>document.fullscreenElement;

/* Chooser */
let chooserResolve=null;
function openChooser(){ return new Promise(res=>{ chooserResolve=res; $("#chooser").style.display="flex"; }); }
function closeChooser(){ $("#chooser").style.display="none"; chooserResolve=null; }
$("#chCancel").onclick=()=>{ chooserResolve?.(null); closeChooser(); };
$("#chCam").onclick=()=>{ chooserResolve?.("cam"); closeChooser(); };
$("#chGal").onclick=()=>{ chooserResolve?.("gal"); closeChooser(); };

/* Tabs */
function switchTab(id){
  document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
  document.querySelector(`[data-tab="${id}"]`).classList.add("active");
  document.querySelectorAll(".pane").forEach(p=>p.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  layoutAll();
}
document.querySelectorAll("[data-tab]").forEach(b=>b.addEventListener("click",()=>switchTab(b.dataset.tab)));

/* Sala / modo subida */
const params = new URLSearchParams(location.search);
const uploadMode = (location.hash === "#subir");
let room = params.get("r") || localStorage.getItem("qr:sala") || (Math.random().toString(36).slice(2,8)).toUpperCase();
localStorage.setItem("qr:sala", room);
if(uploadMode){ document.body.classList.add("up-only"); $("#upload").classList.remove("hidden"); }
else{ $("#pantalla").classList.remove("hidden"); }
$("#roomId").textContent=room; $("#roomId2").textContent=room; $("#roomUp").textContent=room;

/* QR */
function buildUploadURL(){ const url=new URL(location.href); url.searchParams.set("r", room); url.hash="#subir"; return url.toString(); }
function qrImg(url, size){ const i=new Image(); i.alt="QR"; i.src=`https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&margin=0&data=${encodeURIComponent(url)}`; i.style.width="100%"; i.style.height="100%"; i.style.imageRendering="pixelated"; return i; }
function layoutQR(box, viewer, scale=1){
  const pct=Math.min(80,Math.max(20,Number($("#qrPct").value||58)));
  const side=Math.floor(Math.min(viewer.clientWidth,viewer.clientHeight)*pct/100*scale);
  box.style.width=side+"px"; box.style.height=side+"px";
  box.innerHTML=""; box.appendChild(qrImg(buildUploadURL(),side));
}

/* FX placeholder */
class FX{ constructor(cv,host){ this.cv=cv; this.host=host; this.ctx=cv.getContext('2d'); new ResizeObserver(()=>this.resize()).observe(host); this.resize(); requestAnimationFrame(()=>this.loop()); }
  resize(){ const r=this.host.getBoundingClientRect(); const d=Math.min(2,window.devicePixelRatio||1); this.cv.width=Math.max(1,r.width*d); this.cv.height=Math.max(1,r.height*d); this.cv.style.width=r.width+"px"; this.cv.style.height=r.height+"px"; this.ctx.setTransform(d,0,0,d,0,0); }
  loop(){ this.ctx.clearRect(0,0,this.cv.width,this.cv.height); requestAnimationFrame(()=>this.loop()); } }
new FX($("#fxMain"), $("#viewer"));
new FX($("#fxPrev"), $("#viewerPrev"));

/* Estado */
const DEFAULTS = JSON.parse(localStorage.getItem("qr:settings") || "{}");
const S = Object.assign({
  title:"¬°Sub√≠ tu foto con el QR!", subText:"Escane√° y sub√≠ üì≤", font:"Poppins",
  bg:"#000000", text:"#ffffff", qrPct:58,
  titleOffX:0,titleOffY:0, titleScale:100,
  subOffX:0,subOffY:0, subScale:100,
  qrOffX:0, qrOffY:0, qrScale:100,
  logoUrl:"", logoVH:18, logoPos:"center", logoOffX:0, logoOffY:0, logoAlpha:100, logoBlend:"normal", logoScale:100,
  arts:[]
}, DEFAULTS);
let T=null; const ST=()=> T||S; const persist=()=>localStorage.setItem("qr:settings", JSON.stringify(S));

/* Tema */
function applyTheme(){
  document.documentElement.style.setProperty('--bg', $("#bg")?.value || S.bg);
  document.documentElement.style.setProperty('--text', $("#tx")?.value || S.text);
  document.documentElement.style.setProperty('--title-font', `"${($("#fontSel")?.value || S.font)}",system-ui,-apple-system,Segoe UI,Roboto,sans-serif`);
  const s=ST();
  if($("#inpTitle")) s.title=$("#inpTitle").value;
  if($("#inpSub"))   s.subText=$("#inpSub").value;
  if($("#fontSel"))  s.font=$("#fontSel").value;
  if($("#bg"))       s.bg=$("#bg").value;
  if($("#tx"))       s.text=$("#tx").value;
  if($("#qrPct"))    s.qrPct=Number($("#qrPct").value||58);
  layoutAll();
}
["inpTitle","inpSub","bg","tx","fontSel","qrPct"].forEach(id=>$("#"+id)?.addEventListener("input",applyTheme));

/* Pickers con chooser */
async function chooseInto(hiddenCam, hiddenGal){ const sel=await openChooser(); if(sel==="cam") hiddenCam.click(); else if(sel==="gal") hiddenGal.click(); }
let selectedLogoFile=null, selectedArtFile=null, selectedUpFile=null;

$("#btnPickLogo")?.addEventListener("click", ()=>chooseInto($("#logoCam"), $("#logoGal")));
$("#logoCam").addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if(!f) return; selectedLogoFile=f; $("#logoName").textContent=f.name; S.logoUrl=URL.createObjectURL(f); layoutAll(); toast("Logo cargado ‚úÖ"); });
$("#logoGal").addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if(!f) return; selectedLogoFile=f; $("#logoName").textContent=f.name; S.logoUrl=URL.createObjectURL(f); layoutAll(); toast("Logo cargado ‚úÖ"); });

["logoVH","logoPos","logoAlpha","logoBlend"].forEach(id=>{ const el=$("#"+id); if(!el) return; el.addEventListener("input",()=>{ let v=el.value; if(["logoVH","logoAlpha"].includes(id)) v=Number(v); ST()[id]=v; layoutAll(); }); });

/* ART√çCULO */
$("#btnPickArt")?.addEventListener("click", ()=>chooseInto($("#artCam"), $("#artGal")));
$("#artCam").addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if(!f) return; selectedArtFile=f; $("#artName").textContent=f.name; });
$("#artGal").addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if(!f) return; selectedArtFile=f; $("#artName").textContent=f.name; });
$("#btnArtUpload")?.addEventListener("click", ()=>{ const f=selectedArtFile; if(!f){ toast("Eleg√≠ una imagen para el art√≠culo"); return; } const url=URL.createObjectURL(f); const id="art_"+Date.now(); S.arts=S.arts||[]; S.arts.push({id,url,pos:"top-left",sizeVH:18,alpha:100,offX:0,offY:0,scale:100}); persist(); layoutAll(); if(edit) bindSelectables(true); selectedArtFile=null; $("#artName").textContent="Ning√∫n archivo seleccionado"; toast("Art√≠culo subido ‚úÖ"); });

/* Layout */
function placeByPos(el,pos){ const m="18px"; el.style.top=el.style.right=el.style.bottom=el.style.left="auto";
  if(pos==="top-left"){el.style.top=m;el.style.left=m}
  else if(pos==="top-right"){el.style.top=m;el.style.right=m}
  else if(pos==="bottom-left"){el.style.bottom=m;el.style.left=m}
  else if(pos==="bottom-right"){el.style.bottom=m;el.style.right=m}
  else {el.style.top="50%";el.style.left="50%";el.style.transform="translate(-50%,-50%)";} }
function setTS(el,xPct,yPct,scale){ el.style.transformOrigin="center center"; el.style.transform=`translate(${xPct}%, ${yPct}%) scale(${(scale||100)/100})`; }
function layoutViewer(where){
  const s=ST(); const viewer=where==="main"?$("#viewer"):$("#viewerPrev");
  const title=where==="main"?$("#title"):$("#titlePrev"); const sub=where==="main"?$("#sub"):$("#subPrev");
  const qrBox=where==="main"?$("#qrBox"):$("#qrPrev"); const logo=where==="main"?$("#logo"):$("#logoPrev");
  const arts=where==="main"?$("#artsMain"):$("#artsPrev"); const SCALE=(where==="prev")?.7:1;
  if(!viewer) return;
  title.textContent=s.title; sub.textContent=s.subText; title.style.color=s.text; sub.style.color=s.text; viewer.style.background=s.bg;
  layoutQR(qrBox,viewer,SCALE); setTS(qrBox,s.qrOffX||0,s.qrOffY||0,(s.qrScale||100)*(where==="prev"?SCALE*100:100)/100);
  setTS(title,s.titleOffX||0,s.titleOffY||0,(s.titleScale||100)*(where==="prev"?SCALE*100:100)/100);
  setTS(sub,s.subOffX||0,s.subOffY||0,(s.subScale||100)*(where==="prev"?SCALE*100:100)/100);
  if(s.logoUrl){ logo.src=s.logoUrl; logo.style.display="block"; } else { logo.style.display="none"; }
  const logoVH=(s.logoVH||18)*SCALE; logo.style.height=logoVH+"vh"; logo.style.opacity=(s.logoAlpha||100)/100; logo.style.mixBlendMode=s.logoBlend||"normal";
  placeByPos(logo,s.logoPos||"center"); setTS(logo,s.logoOffX||0,s.logoOffY||0,(s.logoScale||100)*(where==="prev"?SCALE*100:100)/100);
  arts.innerHTML=""; (s.arts||[]).forEach(a=>{ const im=new Image(); im.src=a.url; im.className="art"; im.style.height=((a.sizeVH||18)*SCALE)+"vh"; im.style.opacity=(a.alpha||100)/100; placeByPos(im,a.pos||"top-left"); arts.appendChild(im); setTS(im,a.offX||0,a.offY||0,(a.scale||100)); im.dataset.artId=a.id; });
}
function layoutAll(){ layoutViewer("main"); layoutViewer("prev"); }
window.addEventListener("resize", layoutAll);

/* Edici√≥n */
let edit=false, dragging=false, dragEl=null, selectedEl=null, startX=0, startY=0, baseX=0, baseY=0;
const bbox=$("#bbox");
function getKey(el){ if(el?.id==="title")return"title"; if(el?.id==="sub")return"sub"; if(el?.id==="qrBox")return"qr"; if(el?.id==="logo")return"logo"; if(el?.classList?.contains("art"))return"art:"+el.dataset.artId; return""; }
function getOffsets(key){ const s=ST();
  if(key==="title") return {x:s.titleOffX||0,y:s.titleOffY||0,sc:s.titleScale||100,set:(x,y,sc)=>{T.titleOffX=x;T.titleOffY=y;if(sc!=null)T.titleScale=sc;}}
  if(key==="sub")   return {x:s.subOffX||0,y:s.subOffY||0,sc:s.subScale||100,set:(x,y,sc)=>{T.subOffX=x;T.subOffY=y;if(sc!=null)T.subScale=sc;}}
  if(key==="qr")    return {x:s.qrOffX||0,y:s.qrOffY||0,sc:s.qrScale||100,set:(x,y,sc)=>{T.qrOffX=x;T.qrOffY=y;if(sc!=null)T.qrScale=sc;}}
  if(key==="logo")  return {x:s.logoOffX||0,y:s.logoOffY||0,sc:s.logoScale||100,set:(x,y,sc)=>{T.logoOffX=x;T.logoOffY=y;if(sc!=null)T.logoScale=sc;}}
  if(key.startsWith("art:")){ const id=key.split(":")[1]; const a=(s.arts||[]).find(v=>v.id===id)||{offX:0,offY:0,scale:100};
    return {x:a.offX||0,y:a.offY||0,sc:a.scale||100,set:(x,y,sc)=>{const j=T.arts.findIndex(z=>z.id===id); if(j>-1){ T.arts[j]={...T.arts[j],offX:x,offY:y,scale:(sc!=null?sc:T.arts[j].scale||100)}; }}} }
  return {x:0,y:0,sc:100,set:()=>{}} }
function bindSelectables(on){ const els=[$("#title"),$("#sub"),$("#qrBox"),$("#logo"),...$("#artsMain").querySelectorAll(".art")]; els.forEach(el=>{ if(!el) return; el.style.pointerEvents=on?"auto":"none"; if(on){ el.addEventListener("pointerdown",onDown);} else { el.removeEventListener("pointerdown",onDown);} }); }
function onDown(e){ if(!edit) return; dragEl=e.currentTarget; selectedEl=dragEl; dragging=true; dragEl.setPointerCapture?.(e.pointerId); document.querySelectorAll(".is-sel").forEach(n=>n.classList.remove("is-sel")); dragEl.classList.add("is-sel"); const st=getOffsets(getKey(dragEl)); baseX=st.x||0;baseY=st.y||0; startX=e.clientX;startY=e.clientY; showBBox(dragEl); window.addEventListener("pointermove",onMove); window.addEventListener("click",onGlobalClickOnce,{once:true}); window.addEventListener("pointerup",onUp,{once:true}); window.addEventListener("pointercancel",onUp,{once:true}); }
function onMove(e){ if(!dragging||!dragEl) return; const safe=$("#viewer .safe").getBoundingClientRect(); const hw=safe.width/2, hh=safe.height/2; const dx=e.clientX-startX, dy=e.clientY-startY; const nx=baseX+(dx/hw)*100; const ny=baseY+(dy/hh)*100; const sc=(/scale\(([\d.]+)\)/.exec(getComputedStyle(dragEl).transform)?.[1]||1); dragEl.style.transform=`translate(${nx}%, ${ny}%) scale(${sc})`; positionBBox(dragEl); }
function finishDrop(){ if(!dragEl) return; const style=dragEl.style.transform||getComputedStyle(dragEl).transform; const safe=$("#viewer .safe").getBoundingClientRect(); let xPct=baseX, yPct=baseY; const mPct=/translate\(([-\d.]+)%?,\s*([-\d.]+)%?\)/.exec(dragEl.style.transform); if(mPct&&dragEl.style.transform.includes("%")){ xPct=parseFloat(mPct[1]||0); yPct=parseFloat(mPct[2]||0);} else { const mPx=/matrix\([^,]+,[^,]+,[^,]+,[^,]+,([-\d.]+),([-\d.]+)\)/.exec(getComputedStyle(dragEl).transform); if(mPx){ const px=parseFloat(mPx[1]||0), py=parseFloat(mPx[2]||0); xPct=(px/(safe.width/2))*100; yPct=(py/(safe.height/2))*100; } } const scMatch=/scale\(([\d.]+)\)/.exec(style); const sc=scMatch?Math.round(parseFloat(scMatch[1])*100):getOffsets(getKey(dragEl)).sc||100; getOffsets(getKey(dragEl)).set(xPct,yPct,sc); dragEl.classList.remove("is-sel"); dragEl=null; dragging=false; window.removeEventListener("pointermove",onMove); hideBBox(); }
function onUp(){ finishDrop(); } function onGlobalClickOnce(){ finishDrop(); }
let resizing=false, resizeDir="", startScale=100, startWH={w:0,h:0};
const bboxEl=$("#bbox"); function showBBox(el){ bboxEl.style.display="block"; positionBBox(el); } function hideBBox(){ bboxEl.style.display="none"; }
function positionBBox(el){ const r=el.getBoundingClientRect(), host=$("#viewer").getBoundingClientRect(); bboxEl.style.left=(r.left-host.left)+"px"; bboxEl.style.top=(r.top-host.top)+"px"; bboxEl.style.width=r.width+"px"; bboxEl.style.height=r.height+"px"; }
bboxEl.querySelectorAll(".handle").forEach(h=>{ h.addEventListener("pointerdown",(e)=>{ if(!edit) return; e.stopPropagation(); e.preventDefault(); const target=selectedEl; if(!target) return; dragEl=target; const k=getKey(dragEl); const st=getOffsets(k); startScale=st.sc||100; startWH={w:dragEl.getBoundingClientRect().width,h:dragEl.getBoundingClientRect().height}; startX=e.clientX; startY=e.clientY; resizing=true; resizeDir=e.currentTarget.dataset.dir; window.addEventListener("pointermove",onResizeMove); window.addEventListener("pointerup",endResize,{once:true}); window.addEventListener("pointercancel",endResize,{once:true}); }); });
function onResizeMove(e){ if(!resizing||!dragEl) return; const dx=e.clientX-startX, dy=e.clientY-startY; const relX=(resizeDir.includes("e")?dx:resizeDir.includes("w")?-dx:0)/Math.max(40,startWH.w); const relY=(resizeDir.includes("s")?dy:resizeDir.includes("n")?-dy:0)/Math.max(40,startWH.h); const rel=(Math.abs(relX)>Math.abs(relY)?relX:relY); let newScale=Math.max(10,Math.min(400,Math.round((startScale*(1+rel))*1))); const tr=/translate\(([-\d.]+)%?,\s*([-\d.]+)%?\)/.exec(dragEl.style.transform)||[0,0,0]; const tx=parseFloat(tr[1]||0), ty=parseFloat(tr[2]||0); dragEl.style.transform=`translate(${tx}%, ${ty}%) scale(${newScale/100})`; positionBBox(dragEl); const k=getKey(dragEl); const st=getOffsets(k); st.set(st.x,st.y,newScale); }
function endResize(){ resizing=false; }
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
function setEdit(on){ if(on===edit) return; edit=on; if(edit){ T=deepClone(S); $("#viewer").classList.add("select-mode"); $("#btnEdit").classList.add("hidden"); $("#btnSave").classList.remove("hidden"); $("#editHint").classList.remove("hidden"); $("#editChip").style.display="block"; bindSelectables(true); }else{ hideBBox(); T&&Object.assign(S,T); T=null; dragging=false; dragEl=null; selectedEl=null; resizing=false; $("#viewer").classList.remove("select-mode"); $("#btnEdit").classList.remove("hidden"); $("#btnSave").classList.add("hidden"); $("#editHint").classList.add("hidden"); $("#editChip").style.display="none"; bindSelectables(false); persist(); layoutAll(); } }
$("#btnEdit").addEventListener("click",()=>setEdit(true));
$("#btnSave").addEventListener("click",()=>{ setEdit(false); toast("Cambios guardados ‚úÖ"); });

/* Modal QR / Fullscreen / Atajos */
const modal=$("#qrModal"), stage=$("#qrStage"), qrBig=$("#qrBig");
function openQR(){ if(location.hash==="#subir") return; modal.style.display="block"; const s=Math.floor(Math.min(stage.clientWidth,stage.clientHeight)*0.66); qrBig.innerHTML=""; qrBig.appendChild(qrImg(buildUploadURL(),s)); stage.requestFullscreen?.(); $("#qrTitle").textContent=ST().title||"‚Äî"; }
function closeQR(){ modal.style.display="none"; if(isFS()) exitFS(); }
$("#btnQR")?.addEventListener("click", openQR);
$("#btnQRModal")?.addEventListener("click", openQR);
modal?.addEventListener("click",(e)=>{ if(e.target===modal) closeQR(); });
$("#btnFull")?.addEventListener("click", ()=>{ if(isFS()) exitFS(); else enterFS($("#viewer")); });
document.addEventListener("keydown",(e)=>{ if(["KeyF","KeyQ","Escape","KeyE"].includes(e.code)) e.preventDefault(); if(e.code==="KeyF"){ if(isFS()) exitFS(); else enterFS($("#viewer")); } if(e.code==="KeyQ"){ openQR(); } if(e.code==="KeyE"){ setEdit(!edit); } if(e.code==="Escape"){ if(edit){ setEdit(false);} else if(isFS()) exitFS(); } },{capture:true,passive:false});

/* Inicial */
function applyInitial(){ $("#inpTitle")&&($("#inpTitle").value=S.title); $("#inpSub")&&($("#inpSub").value=S.subText); $("#fontSel")&&($("#fontSel").value=S.font); $("#bg")&&($("#bg").value=S.bg); $("#tx")&&($("#tx").value=S.text); $("#qrPct")&&($("#qrPct").value=S.qrPct); $("#roomId").textContent=room; $("#roomId2").textContent=room; $("#roomUp").textContent=room; layoutAll(); }
applyInitial();

/* ======= FIREBASE ======= */
let fb={ ok:false };
async function initFirebase(){
  try{
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js");
    const { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, limit } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js");
    const { getStorage, ref: sRef, uploadBytes, getDownloadURL } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js");

    const firebaseConfig={ apiKey:"AIzaSyBL7pLPNImcTCg4wlO5N1i426hEf3MevUg", authDomain:"qr-proyector.firebaseapp.com", projectId:"qr-proyector", storageBucket:"qr-proyector.appspot.com", messagingSenderId:"1056308881873", appId:"1:1056308881873:web:c48321a62c1597f3ffd8f0", measurementId:"G-7634GLJM1F" };

    const app=initializeApp(firebaseConfig);
    const db=getFirestore(app);
    const st=getStorage(app);
    const col=collection(db,`rooms/${room}/photos`);
    fb={ ok:true, addDoc, serverTimestamp, onSnapshot, query, orderBy, limit, sRef, uploadBytes, getDownloadURL, st, col };

    /* timeline */
    fb.onSnapshot(fb.query(fb.col, fb.orderBy("createdAt","asc")), (snap)=>{
      const photos=[]; snap.forEach(d=>photos.push(d.data()));
      $("#count").textContent=`${photos.length} foto${photos.length===1?"":"s"}`;
      const r=$("#rail"); r.innerHTML=""; photos.forEach(p=>{ const im=new Image(); im.src=p.url; im.alt="Foto"; r.appendChild(im); });
      const ph=$("#photo"), box=$("#qrBox");
      if(!photos.length){ ph.style.display="none"; box.parentElement.style.display="grid"; }
      else{ const last=photos[photos.length-1].url; const bust=last+(last.includes("?")?"&":"?")+"t="+Date.now(); ph.src=bust; ph.onload=()=>{ ph.style.display="block"; box.parentElement.style.display="none"; }; }
    });

    console.log("[Firebase] Inicializado OK");
  }catch(err){
    console.error("[Firebase] No inicializado:", err);
    toast("‚ùó Modo sin conexi√≥n a Firebase");
  }
}
initFirebase();

/* === PICK archivo SUBIR (siempre activo) === */
$("#btnPickUp")?.addEventListener("click", ()=>chooseInto($("#fileUpCam"), $("#fileUpGal")));
$("#fileUpCam").addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if(!f) return; selectedUpFile=f; $("#upName").textContent=f.name; });
$("#fileUpGal").addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if(!f) return; selectedUpFile=f; $("#upName").textContent=f.name; });

/* === CLICK SUBIR (siempre activo, aunque Firebase a√∫n no est√©) === */
$("#btnUp")?.addEventListener("click", async ()=>{
  if(!selectedUpFile){ toast("Eleg√≠ un archivo primero"); return; }
  if(!fb.ok){ toast("‚ùó No conectado a Firebase"); return; }
  try{
    const f=selectedUpFile;
    const name=`${Date.now()}_${(f.name||"foto").replace(/\s+/g,"_")}`;
    const ref=fb.sRef(fb.st,`rooms/${room}/photos/${name}`);
    await fb.uploadBytes(ref,f);
    const url=await fb.getDownloadURL(ref);
    await fb.addDoc(fb.col,{url,createdAt:fb.serverTimestamp()});
    selectedUpFile=null; $("#upName").textContent="Ning√∫n archivo seleccionado";
    toast("Foto subida ‚úÖ");
  }catch(e){
    console.error("[Subir] error", e);
    toast(e?.code==='permission-denied'?'üîí Permiso denegado (reglas)':'Error al subir');
  }
});

/* Reset */
$("#btnReset")?.addEventListener("click", ()=>{ localStorage.removeItem("qr:settings"); location.reload(); });
</script>
</body>
</html>
